---
title: "Novaã®TypedArrayã®reverseã¨toReversedã®å®Ÿè£…ã®é•ã„ã‚’ç†è§£ã™ã‚‹"
description: "a"
date: "2025/04/27"
updatedAt: "2025/04/27"
path: "{{filename}}"
published: true
---

## Intro

Arrayã¨TypedArrayã®ã„ãã¤ã‹ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«ã¯ã€ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ã¨ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãªé•ã„ãŒã‚ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚ä¾‹ãˆã°sortã‚„reverseãªã©ã€‚

ç­†è€…ã¯ç›´è¿‘ã§`%TypedArray%.prototype.reverse`ã¨`%TypedArray%.prototype.toReversed`ã‚’Novaã«å®Ÿè£…ã—ãŸã®ã§ã€ä»Šå›ã¯ãã‚Œãã‚Œã®é•ã„ã«ã¤ã„ã¦æ›¸ã„ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚

- [feat(ecmascript): %TypedArray%.prototype.reverse #593](https://github.com/trynova/nova/pull/593)
- [feat(ecmascript): %TypedArray%.prototype.toReversed #611](https://github.com/trynova/nova/pull/611)

ä½¿ã„æ–¹ãªã©ã¯ãŸãã•ã‚“ã™ã§ã«è¨˜äº‹ã¯ã‚ã‚‹ã¨æ€ã†ã®ã§ã€ãã®è¾ºã‚Šã¯å‰²æ„›ã—ã¾ã™ã€‚

## ä»•æ§˜æ›¸ã«ãŠã„ã¦ã®é•ã„

reverseã¯ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãªãƒ¡ã‚½ãƒƒãƒ‰ã«ãªã‚‹ã®ã§ã€æœ¬ä½“ãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥å¤‰æ›´ã™ã‚Œã°å•é¡Œãªã„ã§ã™ã€‚ä»•æ§˜æ›¸ã‚’è¦‹ã¦ã‚‚ã€ç‰¹æ®µæ°—ã«ãªã‚‹ã‚ˆã†ãªç‚¹ã¯ãªãã„ã¤ã‚‚é€šã‚Šã¨ã„ã£ãŸæ„Ÿã˜ã§ã™ã€‚

ã—ã‹ã—toReveresedã¯ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãªãƒ¡ã‚½ãƒƒãƒ‰ã«ãªã‚‹ã®ã§ã€æœ¬ä½“ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãæ›ãˆãªã„ã‚ˆã†ã«ã—ãªã„ã¨ã„ã‘ãªã„ã§ã™ã€‚ã“ã‚ŒãŒå®Ÿè£…å‰ã¯ç­†è€…ã¨ã—ã¦ã¯ã‚ã¾ã‚Šã‚¤ãƒ¡ãƒ¼ã‚¸ãŒæ¹§ã„ã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚

ã¨ã„ã†ã‚ã‘ã§è¦‹ã¦ã¿ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚

<table>
  <thead>
    <tr>
      <th>TypedArray.prototype.toReversed</th>
      <th>TypedArray.prototype.reverse</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>
        <emu-alg>
            <ol>
                <li>Let <var>O</var> be the <emu-val>this</emu-val> value.</li>
                <li>Let <var>taRecord</var> be ? <emu-xref aoid="ValidateTypedArray">ValidateTypedArray</emu-xref>(<var>O</var>, <emu-const>seq-cst</emu-const>).</li>
                <li>Let <var>length</var> be <emu-xref aoid="TypedArrayLength">TypedArrayLength</emu-xref>(<var>taRecord</var>).</li>
                <li>Let <var>A</var> be ? <emu-xref aoid="TypedArrayCreateSameType">TypedArrayCreateSameType</emu-xref>(<var>O</var>, Â« <emu-xref aoid="ğ”½">ğ”½</emu-xref>(<var>length</var>) Â»).</li>
                <li>Let <var>k</var> be 0.</li>
                <li>
                Repeat, while <var>k</var> &lt; <var>length</var>:
                <ol>
                    <li>Let <var>from</var> be ! <emu-xref aoid="ToString">ToString</emu-xref>(<emu-xref aoid="ğ”½">ğ”½</emu-xref>(<var>length</var> - <var>k</var> - 1)).</li>
                    <li>Let <var>Pk</var> be ! <emu-xref aoid="ToString">ToString</emu-xref>(<emu-xref aoid="ğ”½">ğ”½</emu-xref>(<var>k</var>)).</li>
                    <li>Let <var>fromValue</var> be ! <emu-xref aoid="Get">Get</emu-xref>(<var>O</var>, <var>from</var>).</li>
                    <li>Perform ! <emu-xref aoid="Set">Set</emu-xref>(<var>A</var>, <var>Pk</var>, <var>fromValue</var>, <emu-val>true</emu-val>).</li>
                    <li>Set <var>k</var> to <var>k</var> + 1.</li>
                </ol>
                </li>
                <li>Return <var>A</var>.</li>
            </ol>
        </emu-alg>
      </td>
      <td>
        <emu-alg>
            <ol>
                <li>Let <var>O</var> be the <emu-val>this</emu-val> value.</li>
                <li>Let <var>taRecord</var> be ? <emu-xref aoid="ValidateTypedArray">ValidateTypedArray</emu-xref>(<var>O</var>, <emu-const>seq-cst</emu-const>).</li>
                <li>Let <var>len</var> be <emu-xref aoid="TypedArrayLength">TypedArrayLength</emu-xref>(<var>taRecord</var>).</li>
                <li>Let <var>middle</var> be <emu-xref aoid="floor">floor</emu-xref>(<var>len</var> / 2).</li>
                <li>Let <var>lower</var> be 0.</li>
                <li>
                    Repeat, while <var>lower</var> â‰  <var>middle</var>:
                    <ol>
                        <li>Let <var>upper</var> be <var>len</var> - <var>lower</var> - 1.</li>
                        <li>Let <var>upperP</var> be ! <emu-xref aoid="ToString">ToString</emu-xref>(<emu-xref aoid="ğ”½">ğ”½</emu-xref>(<var>upper</var>)).</li>
                        <li>Let <var>lowerP</var> be ! <emu-xref aoid="ToString">ToString</emu-xref>(<emu-xref aoid="ğ”½">ğ”½</emu-xref>(<var>lower</var>)).</li>
                        <li>Let <var>lowerValue</var> be ! <emu-xref aoid="Get">Get</emu-xref>(<var>O</var>, <var>lowerP</var>).</li>
                        <li>Let <var>upperValue</var> be ! <emu-xref aoid="Get">Get</emu-xref>(<var>O</var>, <var>upperP</var>).</li>
                        <li>Perform ! <emu-xref aoid="Set">Set</emu-xref>(<var>O</var>, <var>lowerP</var>, <var>upperValue</var>, <emu-val>true</emu-val>).</li>
                        <li>Perform ! <emu-xref aoid="Set">Set</emu-xref>(<var>O</var>, <var>upperP</var>, <var>lowerValue</var>, <emu-val>true</emu-val>).</li>
                        <li>Set <var>lower</var> to <var>lower</var> + 1.</li>
                    </ol>
                </li>
                <li>Return <var>O</var>.</li>
            </ol>
        </emu-alg>
      </td>
    </tr>
  </tbody>
</table>

toReversedã«ã¯ã€`TypedArrayCreateSameType`ã¨ã„ã†abstruct operationãŒã‚ã‚Šã¾ã™ã€‚
ã“ã‚Œã‚’ã¿ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

<div style="border: 1px solid #ccc; padding: 1em; border-radius: 6px;">
  <emu-alg>
    <ol>
      <li>Let <var>constructor</var> be the intrinsic object associated with the <emu-xref>constructor</emu-xref> name <var>exemplar</var>.<var>[[TypedArrayName]]</var> in <emu-xref>Table 75</emu-xref>.</li>
      <li>Let <var>result</var> be ? <emu-xref aoid="TypedArrayCreateFromConstructor">TypedArrayCreateFromConstructor</emu-xref>(<var>constructor</var>, <var>argumentList</var>).</li>
      <li><emu-xref>Assert</emu-xref>: <var>result</var> has <var>[[TypedArrayName]]</var> and <var>[[ContentType]]</var> internal slots.</li>
      <li><emu-xref>Assert</emu-xref>: <var>result</var>.<var>[[ContentType]]</var> is <var>exemplar</var>.<var>[[ContentType]]</var>.</li>
      <li>Return <var>result</var>.</li>
    </ol>
  </emu-alg>
</div>

ã“ã®abstract operationã§ã¯ã€åŒã˜å‹ã®TypedArrayã®ã‚³ãƒ”ãƒ¼ã‚’ä½œã‚‹ã‚ˆã†æ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€‚ãŸã ã‚³ãƒ”ãƒ¼ã¨è¨€ã£ã¦ã‚‚å®Œå…¨ãªã‚³ãƒ”ãƒ¼ã§ã¯ãªãã€å…ƒã®é…åˆ—ã¨åŒã˜é•·ã•ã®ç©ºã£ã½ã®é…åˆ—ãŒä½œã‚‰ã‚Œã¾ã™ã€‚

ãã—ã¦å…ƒã®é…åˆ—ã®å€¤ã‚’é€†é †ã«ã‚»ãƒƒãƒˆã—ã¦ã„ãã€çµ‚ã‚ã‚Œã°ã‚³ãƒ”ãƒ¼å¾Œã®å€¤ã‚’è¿”ã›ã°ã€toReversedã®å®Œæˆã§ã™ã€‚

## Novaã®å®Ÿè£…

reverseã¯rustã§ã¯å˜ç´”ã«mutableãªsliceã¨ã—ã¦æ‰±ãˆã‚‹ã®ã§ã€æ¯”è¼ƒçš„å®Ÿè£…ã¯ç°¡å˜ã§ã™ã€‚

```rs
fn reverse_typed_array<'a, T: Viewable + Copy + std::fmt::Debug>(
    agent: &mut Agent,
    ta: TypedArray,
    len: usize,
    gc: NoGcScope<'a, '_>,
) -> JsResult<'a, ()> {
    let array_buffer = ta.get_viewed_array_buffer(agent, gc);
    let byte_offset = ta.byte_offset(agent);
    let byte_length = ta.byte_length(agent);
    let byte_slice = array_buffer.as_mut_slice(agent);
    if byte_slice.is_empty() {
        return Ok(());
    }
    let byte_slice = if let Some(byte_length) = byte_length {
        let end_index = byte_offset + byte_length;
        if end_index > byte_slice.len() {
            return Ok(());
        }
        &mut byte_slice[byte_offset..end_index]
    } else {
        &mut byte_slice[byte_offset..]
    };
    let (head, slice, _) = unsafe { byte_slice.align_to_mut::<T>() };
    if !head.is_empty() {
        return Err(agent.throw_exception_with_static_message(
            ExceptionType::TypeError,
            "TypedArray is not properly aligned",
            gc,
        ));
    }
    let slice = &mut slice[..len];
    slice.reverse();
    Ok(())
}
```

ãã‚Œã«å¯¾ã—toReversedã¯ã¾ã é«˜é€ŸåŒ–ã¾ã§ã§ãã¦ãªãã€ãã®ã¾ã¾ã®å®Ÿè£…ã§ã™ã€‚

```rs
// 6. Repeat, while k < length,
while k < len {
    // a. Let from be ! ToString(ğ”½(length - k - 1)).
    let from = PropertyKey::Integer((len - k - 1).try_into().unwrap());
    // b. Let Pk be ! ToString(ğ”½(k)).
    let pk = PropertyKey::try_from(k).unwrap();
    // c. Let fromValue be ! Get(O, from).
    let from_value = get(agent, scoped_o.get(agent), from, gc.reborrow())
        .unbind()?
        .bind(gc.nogc());
    // d. Perform ! Set(A, Pk, fromValue, true).
    unwrap_try(try_set(
        agent,
        scope_a.get(agent).into_object(),
        pk,
        from_value.unbind(),
        true,
        gc.nogc(),
    ))
    .unwrap();
    // . Set k to k + 1.
    k += 1;
}
```

ã“ã®ã‚ˆã†ã«ãƒ«ãƒ¼ãƒ—ã‚’ã‹ãã¨å½“ç„¶é…åˆ—ã®æ•°ãŒå¤šããªã‚‹ã¨é…ããªã‚‹ã®ã§ã€ãªã‚“ã¨ã‹ã—ãŸã„ã¨ã“ã‚ã§ã™ã€‚

ä»Šè€ƒãˆã‚‹ã¨ã€æœ¬ä½“ã®ã‚¹ãƒ©ã‚¤ã‚¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€ãã‚Œã‚’reverseã—ã¦è¿”ã™ã£ã¦ã“ã¨ã‚’ã™ã‚Œã°è‰¯ã‹ã£ãŸã‚ˆã†ãªæ°—ãŒã™ã‚‹ãŒã€ãã‚Œã‚’ã™ã‚‹ã¨å€Ÿç”¨ãƒã‚§ãƒƒã‚«ãƒ¼ã«æ€’ã‚‰ã‚ŒãŸã‚ˆã†ãª...ï¼ˆã‚ã¾ã‚Šè¦šãˆã¦ãªã„...ï¼‰

ã„ã¤ã‹ã‚„ã‚Šã¾ã™ã€‚

## å®Ÿè¡Œé€Ÿåº¦

reverseã¯ã™ã§ã«ãã‚Œãªã‚Šã®é€Ÿåº¦ã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚“ã§ã™ãŒã€toReversedã¯ç¾çŠ¶ã®Novaã®TypedArrayã®æ§‹é€ ä¸Šå°‘ã—é¢å€’ã ã£ãŸã®ã§ç‰¹ã«ä½•ã‚‚ã—ã¦ãªã„ã§ã™ã€‚

```js
const SIZE = 10_000_000;
const arr = new Uint32Array(SIZE);
arr.toReversed(9999999);

// toReversed
~/Desktop/blog on î‚  main [$?]
â¯ time andromeda run index.js
andromeda run index.js  0.39s user 0.02s system 97% cpu 0.423 total

const SIZE = 10_000_000;
const arr = new Uint32Array(SIZE);
arr.reverse(9999999);

~/Desktop/blog on î‚  main [$?]
â¯ time andromeda run index.js
andromeda run index.js  0.00s user 0.01s system 53% cpu 0.019 total
```

è©¦ã—ã«æ¸¬ã£ã¦ã¿ã¾ã—ãŸãŒã€æ€ã£ãŸã‚ˆã‚ŠtoReversedã‚‚æ—©ã‹ã£ãŸã€‚ï¼ˆandromedaã¨ã¯Novaã‚’ä½¿ã£ãŸruntimeã§ã™ï¼‰

## ã¾ã¨ã‚
