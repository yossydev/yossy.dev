---
title: "ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ãŸNovaã®TypedArray.prototype.indexOfã®æœ€é©åŒ–"
description: "a"
date: "2025/03/09"
updatedAt: "2025/03/09"
path: "nova-typed-array-indexOf-more-optimized"
published: true
---

## Intro

å…ˆæ—¥ã€Novaã«`%TypedArray%.prototype.indexOf`([#556](https://github.com/trynova/nova/pull/556))ã¨ã„ã†PRãŒãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸã€‚

å¤§æ ã®éƒ¨åˆ†ã¯ä»–ã®å®Ÿè£…ã¨åŒã˜ãªã‚“ã§ã™ãŒã€ä»Šå›è¡Œã£ãŸæœ€é©åŒ–ã®æ–¹æ³•ãŒå‚è€ƒã«ãªã£ãŸã®ã§ãƒ¡ãƒ¢ãŒã¦ã‚‰æ®‹ã—ã¦ãŠãã¾ã™ã€‚

ãªãŠã€ã¾ã ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã¯å–ã£ã¦ã„ãªã„ã®ã§ã€å¤šåˆ†ã“ã£ã¡ã®æ–¹ãŒæ—©ã„ç¨‹åº¦ã§ã™ã€‚

## %TypedArray%.prototype.indexOfã®ä»•æ§˜

[%TypedArray%.prototype.indexOf](https://tc39.es/ecma262/multipage/indexed-collections.html#sec-%typedarray%.prototype.indexof)ã¯ã€
å¼•æ•°ã«å—ã‘å–ã£ãŸå€¤ã®indexç•ªå·ç›®ã®å€¤ã‚’è¿”ã™ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚

åŸºæœ¬çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ä½¿ç”¨ã—ã¾ã™ã€‚

```ts
// ref: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray/indexOf#try_it

const uint8 = new Uint8Array([10, 20, 30, 40, 50]);

console.log(uint8.indexOf(50));
// Expected output: 4
```

ãã—ã¦ã€ã‚‚ã—æŒ‡å®šã—ãŸå€¤ãŒå­˜åœ¨ã—ãªã‹ã£ãŸå ´åˆã¯-1ã‚’è¿”ã—ã¾ã™ã€‚
ã‚ã¨ã¯ç¬¬äºŒå¼•æ•°ã®fromIndexã«å€¤ã‚’å…¥ã‚Œã‚‹ã“ã¨ã§ã€indexç•ªç›®ç§»è¡Œã‹ã‚‰æ¢ç´¢ã‚’å§‹ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã™ã€‚

```ts
// From position 3
console.log(uint8.indexOf(20, 3));
// Expected output: -1

console.log(uint8.indexOf(51));
// Expected output: -1
```

åŸºæœ¬çš„ã«ã¯[Array.prototype.indexOf()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/indexOf)ã¨åŒã˜ã§ã™ãŒã€
TypedArrayã¯[TypedArray objects](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray#typedarray_objects)ã—ã‹æ‰±ãˆã¾ã›ã‚“ã€‚

### ä»•æ§˜æ›¸ã‚’è¦‹ã‚‹
ã“ã“ã§ã€ä»Šå›ã®æœ€é©åŒ–ã®ãƒã‚¤ãƒ³ãƒˆã§ã‚ã‚‹ã€indexOfã®æ¢ç´¢æ–¹æ³•ã‚’ç¢ºèªã—ã¾ã™ã€‚

ã“ã‚Œã¯ã€ä»•æ§˜æ›¸ã‚’è¦‹ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```
11. Repeat, while k < len,
    a. Let Pk be ! ToString(ğ”½(k)).
    b. Let kPresent be ! HasProperty(O, Pk).
    c. If kPresent is true, then
       i. Let elementK be ! Get(O, Pk).
       ii. If IsStrictlyEqual(searchElement, elementK) is true, return ğ”½(k).
    d. Set k to k + 1.
```

lenã¯TypedArrayã®legnthã§ã€kã¯ã“ã“ã§ã¯æœ€åˆã¯0ã¨ã—ã¦è€ƒãˆã¦ã‚‚ã‚‰ã£ã¦å•é¡Œãªã„ã§ã™ã€‚

ãã—ã¦ã€lengthãŒkeyã‚ˆã‚Šå¤§ãã„æ•°å­—ã§ã‚ã‚‹é™ã‚Šã€ãƒ«ãƒ¼ãƒ—ã‚’ç¶šã‘ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

ã“ã‚ŒãŒæœ€çµ‚çš„ã«ã€indexOfã«æ¸¡ã•ã‚ŒãŸå¼•æ•°ï¼ˆsearchElementï¼‰ã¨ã€TypedArrayã«å®šç¾©ã—ãŸå€¤ï¼ˆelementK)ã‚’æ¯”è¼ƒã—ã€ç­‰ä¾¡ã§ã‚ã‚Œã°ã€kã‚’è¿”ã™ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

## æœ€é©åŒ–

çµè«–ã‚’æ›¸ã„ã¦ãŠãã¨ã€ãƒ«ãƒ¼ãƒ—é–‹å§‹æ™‚ç‚¹ã§TypedArrayã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€`u8/i8/u16/i16/(f16)/u32/i32/f32/u64/i64/f64`ã®ã©ã‚Œã‹ã§ã‚ã‚‹ã“ã¨ã¯ã‚ã‹ã£ã¦ã„ã‚‹ã®ã§ã€
matchã‚’ä½¿ã£ã¦ä¸€è‡´ã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¹ãƒ©ã‚¤ã‚¹ãƒ‡ãƒ¼ã‚¿ã«rustã®index_ofã‚’å®Ÿè¡Œã™ã‚‹ã€‚ã¨ã„ã†ã“ã¨ã‚’è¡Œã„ã¾ã—ãŸã€‚

ä»¥é™ã§è©³ç´°ã‚’èª¬æ˜ã—ã¾ã™ã€‚

------

indexOfã®æœ€å¾Œã®æ¢ç´¢ã¯ã‚ˆã†ã¯å˜ç´”ãªãƒ«ãƒ¼ãƒ—å‡¦ç†ã§ã—ãŸã€‚

ãªã®ã§ç­†è€…ã‚‚ã“ã‚Œã‚’å®Ÿè£…ã—ãŸéš›ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ„šç›´ã«ãƒ«ãƒ¼ãƒ—å‡¦ç†ã‚’è¡Œã„ã¾ã—ãŸã€‚

```rs
// 11. Repeat, while k < len,
while k < len {
    // a. Let kPresent be ! HasProperty(O, ! ToString(ğ”½(k))).
    let k_present = has_property(
        agent,
        o.get(agent).into_object(),
        PropertyKey::from(SmallInteger::from(k as u32)),
        gc.reborrow(),
    )?;
    // b. If kPresent is true, then
    if k_present {
        //  i. Let elementK be ! Get(O, ! ToString(ğ”½(k))).
        let element_k = unwrap_try(try_get(
            agent,
            o.get(agent),
            PropertyKey::from(SmallInteger::from(k as u32)),
            gc.nogc(),
        ));
        //  ii. If IsStrictlyEqual(searchElement, elementK) is true, return ğ”½(k).
        if is_strictly_equal(agent, search_element, element_k) {
            return Ok(k.try_into().unwrap());
        }
    }
    // c. Set k to k + 1.
    k += 1
}
```

ä»•æ§˜æ›¸é€šã‚Šã«å¿ å®Ÿã«å†ç¾ã—ãŸçµæœã§ã™ã€‚

### rustã®index_ofã‚’ä½¿ç”¨ã™ã‚‹

ã•ã¦ã€ä»Šå›ã®ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆã§ã‚ã‚‹ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ãŸæœ€é©åŒ–ã«ã¤ã„ã¦ã§ã™ã€‚

ã“ã“ã«æ¥ãŸæ™‚ç‚¹ã§ã€TypedArrayãŒã©ã®æ•°å­—ãªã®ã‹ã¯ã‚ã‹ã£ã¦ã„ã¾ã™ã€‚ãªã®ã§ã€ãã®ãƒ‡ãƒ¼ã‚¿ã®ã‚¹ãƒ©ã‚¤ã‚¹ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã€ãã‚Œã«å¯¾ã—ã¦rustã®index_ofã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
ä»¥é™ã¯å°‘ã—ç«¯æŠ˜ã‚ŠãªãŒã‚‰ã®èª¬æ˜ã«ã¯ãªã‚Šã¾ã™ã€‚

ã¾ãšã€é…åˆ—ã®ã‚¹ãƒ©ã‚¤ã‚¹ã‚’å–å¾—ã—ã¾ã™

```rs
let byte_slice = array_buffer.as_slice(agent);
```

ãã—ã¦typedarrayã«[byteOffset](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray/byteOffset)ãŒæŒ‡å®šã•ã‚Œã¦ã„ãŸæ™‚ã®ã“ã¨ã‚‚è€ƒæ…®ã—ã¦ã„ã¾ã™ã€‚

byteoffsetãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°ãã‚Œä»¥é™ã®ã‚¹ãƒ©ã‚¤ã‚¹ã‚’å–å¾—ã™ã‚‹æ„Ÿã˜ã§ã™ã€‚

```rs
let byte_slice = if let Some(byte_length) = byte_length {
    let end_index = byte_offset + byte_length;
    if end_index > byte_slice.len() {
        // End index is out of bounds.
        return Ok(None);
    }
    &byte_slice[byte_offset..end_index]
} else {
    &byte_slice[byte_offset..]
};
```

æ¬¡ã«align_toã‚’ä½¿ç”¨ã—ãŸã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆ

- align_to ã¯ã‚¹ãƒ©ã‚¤ã‚¹ã‚’å®‰å…¨ã«åˆ¥ã®å‹ã®ã‚¹ãƒ©ã‚¤ã‚¹ã«å¤‰æ›ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
- ã‚¢ãƒ©ã‚¤ãƒ³ã•ã‚Œã¦ã„ãªã„ãƒ‡ãƒ¼ã‚¿ã¯ prefix / suffix ã«æŒ¯ã‚Šåˆ†ã‘ã‚‰ã‚Œã€å®‰å…¨æ€§ã‚’ç¢ºä¿ã™ã‚‹
- ãƒªãƒˆãƒ«ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³ç’°å¢ƒã§ã¯ã€ãƒã‚¤ãƒˆé †ãŒé€†ã«ãªã‚‹ã®ã§æ³¨æ„ãŒå¿…è¦

å®Ÿã¯rustæœ¬ä½“ã«ã‚‚ã€index_ofã¨ã„ã†ã‚‚ã®ã¯ã‚ã‚Šã¾ã™ã€‚[https://crates.io/crates/index_of](https://crates.io/crates/index_of)

## è‹¦æˆ¦ã—ãŸãƒã‚¤ãƒ³ãƒˆ

### Rustãã®ã‚‚ã®ã®ç†è§£

### 

## ã¾ã¨ã‚