---
title: "ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ãŸNovaã®TypedArray.prototype.indexOfã®æœ€é©åŒ–"
description: "å…ˆæ—¥ã€Novaã«%TypedArray%.prototype.indexOfã®å®Ÿè£…ãŒãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸã€‚å¤§æ ã®éƒ¨åˆ†ã¯ä»–ã®å®Ÿè£…ã¨åŒã˜ãªã‚“ã§ã™ãŒã€ä»Šå›è¡Œã£ãŸæœ€é©åŒ–ã®æ–¹æ³•ãŒå‚è€ƒã«ãªã£ãŸã®ã§ãƒ¡ãƒ¢ãŒã¦ã‚‰æ®‹ã—ã¦ãŠãã¾ã™ã€‚ã¡ãªã¿ã«ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã«ã¯ãªã‚Šã¾ã™ãŒã€ã“ã®æœ€é©åŒ–ã§æ‰‹å…ƒã§ã¯ç´„28å€ã»ã©æ—©ããªã£ã¦ã„ã¾ã—ãŸã€‚"
date: "2025/03/17"
updatedAt: "2025/03/17"
path: "nova-typed-array-indexOf-more-optimized"
published: true
---

## Intro

å…ˆæ—¥ã€Novaã«`%TypedArray%.prototype.indexOf`([#556](https://github.com/trynova/nova/pull/556))ã®å®Ÿè£…ãŒãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸã€‚

å¤§æ ã®éƒ¨åˆ†ã¯ä»–ã®TypedArrayã®å®Ÿè£…ã¨åŒã˜ãªã‚“ã§ã™ãŒã€ä»Šå›ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã‚‚ã‚‰ã£ãŸæœ€é©åŒ–ã®æ–¹æ³•ãŒå‹‰å¼·ã«ãªã£ãŸã®ã§ãƒ¡ãƒ¢ãŒã¦ã‚‰æ®‹ã—ã¦ãŠãã¾ã™ã€‚

ã¡ãªã¿ã«ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã«ã¯ãªã‚Šã¾ã™ãŒã€ã“ã®æœ€é©åŒ–ã§æ‰‹å…ƒã§ã¯ç´„28å€ã»ã©æ—©ããªã£ã¦ã„ã¾ã—ãŸã€‚

## %TypedArray%.prototype.indexOfã®ä»•æ§˜

[%TypedArray%.prototype.indexOf](https://tc39.es/ecma262/multipage/indexed-collections.html#sec-%typedarray%.prototype.indexof)ã¯ã€
å¼•æ•°ã«å—ã‘å–ã£ãŸå€¤ã®indexç•ªå·ç›®ã®å€¤ã‚’è¿”ã™ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚

åŸºæœ¬çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ä½¿ç”¨ã—ã¾ã™ã€‚

```ts
// ref: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray/indexOf#try_it

const uint8 = new Uint8Array([10, 20, 30, 40, 50]);

console.log(uint8.indexOf(50));
// Expected output: 4
```

ãã—ã¦ã€ã‚‚ã—æŒ‡å®šã—ãŸå€¤ãŒå­˜åœ¨ã—ãªã‹ã£ãŸå ´åˆã¯-1ã‚’è¿”ã—ã¾ã™ã€‚
ã‚ã¨ã¯ç¬¬äºŒå¼•æ•°ã®fromIndexã«å€¤ã‚’å…¥ã‚Œã‚‹ã“ã¨ã§ã€indexç•ªç›®ä»¥é™ã‹ã‚‰ã§æ¢ç´¢ã‚’å§‹ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã™ã€‚

```ts
// From position 3
console.log(uint8.indexOf(20, 3));
// Expected output: -1

console.log(uint8.indexOf(51));
// Expected output: -1
```

åŸºæœ¬çš„ã«ã¯[Array.prototype.indexOf()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/indexOf)ã¨åŒã˜ã§ã™ãŒã€
TypedArrayã¯[TypedArray objects](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray#typedarray_objects)ã—ã‹æ‰±ãˆã¾ã›ã‚“ã€‚

### ä»•æ§˜æ›¸ã‚’è¦‹ã‚‹
ã“ã“ã§ã€ä»Šå›ã®æœ€é©åŒ–ã®ãƒã‚¤ãƒ³ãƒˆã§ã‚ã‚‹ã€indexOfã®æ¢ç´¢æ–¹æ³•ã‚’ç¢ºèªã—ã¾ã™ã€‚

ã“ã‚Œã¯ã€ä»•æ§˜æ›¸ã‚’è¦‹ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```
11. Repeat, while k < len,
    a. Let Pk be ! ToString(ğ”½(k)).
    b. Let kPresent be ! HasProperty(O, Pk).
    c. If kPresent is true, then
       i. Let elementK be ! Get(O, Pk).
       ii. If IsStrictlyEqual(searchElement, elementK) is true, return ğ”½(k).
    d. Set k to k + 1.
```

lenã¯TypedArrayã®legnthã§ã€kã¯ã“ã“ã§ã¯æœ€åˆã¯0ã¨ã—ã¦è€ƒãˆã¦ã‚‚ã‚‰ã£ã¦å•é¡Œãªã„ã§ã™ã€‚

ãã—ã¦ã€lengthãŒkã‚ˆã‚Šå¤§ãã„æ•°å­—ã§ã‚ã‚‹é™ã‚Šã€ãƒ«ãƒ¼ãƒ—ã‚’ç¶šã‘ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

ã“ã‚ŒãŒæœ€çµ‚çš„ã«ã€indexOfã«æ¸¡ã•ã‚ŒãŸå¼•æ•°ï¼ˆsearchElementï¼‰ã¨ã€TypedArrayã«å®šç¾©ã—ãŸå€¤ï¼ˆelementKï¼‰ã‚’æ¯”è¼ƒã—ã€ç­‰ä¾¡ã§ã‚ã‚Œã°ã€kã‚’è¿”ã™ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

## æœ€é©åŒ–

çµè«–ã‚’æ›¸ã„ã¦ãŠãã¨ã€ãƒ«ãƒ¼ãƒ—é–‹å§‹æ™‚ç‚¹ã§TypedArrayã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€`u8/i8/u16/i16/(f16)/u32/i32/f32/u64/i64/f64`ã®ã©ã‚Œã‹ã§ã‚ã‚‹ã“ã¨ã¯ã‚ã‹ã£ã¦ã„ã‚‹ã®ã§ã€
matchã‚’ä½¿ã£ã¦ä¸€è‡´ã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¹ãƒ©ã‚¤ã‚¹ãƒ‡ãƒ¼ã‚¿ã¨rustã®positionã‚’æ¯”è¼ƒã™ã‚‹ã¨ã„ã†ã“ã¨ã‚’è¡Œã„ã¾ã—ãŸã€‚æœ¬è¨˜äº‹å†…ã§ã¯ç°¡ç•¥åŒ–ã®ãŸã‚çœç•¥ã—ãŸã‚³ãƒ¼ãƒ‰ã‚’è¼‰ã›ã¦ã„ã‚‹ã®ã§ã€å…¨ã¦è¦‹ãŸã„æ–¹ã¯[ã“ã¡ã‚‰](https://github.com/trynova/nova/blob/4897baa595621a11bb99c7400360c7d810b2453c/nova_vm/src/ecmascript/builtins/indexed_collections/typed_array_objects/typed_array_intrinsic_object.rs#L2089-L2152)ã‹ã‚‰ã”è¦§ãã ã•ã„

ä»¥é™ã§è©³ç´°ã‚’èª¬æ˜ã—ã¾ã™ã€‚

------

indexOfã®æœ€å¾Œã®æ¢ç´¢ã¯ã‚ˆã†ã¯å˜ç´”ãªãƒ«ãƒ¼ãƒ—å‡¦ç†ã§ã—ãŸã€‚

ãªã®ã§ç­†è€…ã‚‚ã“ã‚Œã‚’å®Ÿè£…ã—ãŸéš›ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ„šç›´ã«ãƒ«ãƒ¼ãƒ—å‡¦ç†ã‚’è¡Œã„ã¾ã—ãŸã€‚

```rs
// 11. Repeat, while k < len,
while k < len {
    // a. Let kPresent be ! HasProperty(O, ! ToString(ğ”½(k))).
    let k_present = has_property(
        agent,
        o.get(agent).into_object(),
        PropertyKey::from(SmallInteger::from(k as u32)),
        gc.reborrow(),
    )?;
    // b. If kPresent is true, then
    if k_present {
        //  i. Let elementK be ! Get(O, ! ToString(ğ”½(k))).
        let element_k = unwrap_try(try_get(
            agent,
            o.get(agent),
            PropertyKey::from(SmallInteger::from(k as u32)),
            gc.nogc(),
        ));
        //  ii. If IsStrictlyEqual(searchElement, elementK) is true, return ğ”½(k).
        if is_strictly_equal(agent, search_element, element_k) {
            return Ok(k.try_into().unwrap());
        }
    }
    // c. Set k to k + 1.
    k += 1
}
```

ä»•æ§˜æ›¸é€šã‚Šã«å¿ å®Ÿã«å†ç¾ã—ãŸçµæœã§ã™ã€‚
ã“ã‚Œã ã‘ã§ã‚‚ã€test262è‡ªä½“ã¯ååˆ†ã«é€šã‚Šã¾ã—ãŸã€‚

### ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹

ã•ã¦ã€ä»Šå›ã®ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆã§ã‚ã‚‹ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ãŸæœ€é©åŒ–ã«ã¤ã„ã¦ã§ã™ã€‚

ã“ã“ã«æ¥ãŸæ™‚ç‚¹ã§ã€TypedArrayãŒã©ã®æ•°å­—ãªã®ã‹ã¯ã‚ã‹ã£ã¦ã„ã¾ã™ã€‚ãªã®ã§ã€ãã®ãƒ‡ãƒ¼ã‚¿ã®ã‚¹ãƒ©ã‚¤ã‚¹ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã€ãã‚Œã«å¯¾ã—ã¦rustã®`iter().positoin`ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
ä»¥é™ã¯å°‘ã—ç«¯æŠ˜ã‚ŠãªãŒã‚‰ã®èª¬æ˜ã«ã¯ãªã‚Šã¾ã™ã€‚

ã¾ãšã€é…åˆ—ã®ã‚¹ãƒ©ã‚¤ã‚¹ã‚’å–å¾—ã—ã¾ã™

```rs
let byte_slice = array_buffer.as_slice(agent);
```

ãã—ã¦typedarrayã«[byteOffset](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray/byteOffset)ãŒæŒ‡å®šã•ã‚Œã¦ã„ãŸæ™‚ã®ã“ã¨ã‚‚è€ƒæ…®ã—ã¦ã„ã¾ã™ã€‚

byteoffsetãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°ãã‚Œä»¥é™ã®ã‚¹ãƒ©ã‚¤ã‚¹ã‚’å–å¾—ã™ã‚‹æ„Ÿã˜ã§ã™ã€‚

```rs
let byte_slice = if let Some(byte_length) = byte_length {
    let end_index = byte_offset + byte_length;
    if end_index > byte_slice.len() {
        // End index is out of bounds.
        return Ok(None);
    }
    &byte_slice[byte_offset..end_index]
} else {
    &byte_slice[byte_offset..]
};
```

æ¬¡ã«`as_slice`ã¯`[&u8]`å‹ãªã®ã§ã€[align_to](https://doc.rust-lang.org/std/primitive.slice.html#method.align_to)ã‚’ä½¿ç”¨ã—ã€Tå‹ï¼ˆTypedArrayå‹ï¼‰ã¸ã®å¤‰æ›ã‚’è¡Œã„ã¾ã™ã€‚
align_toã¯prefix,slice,suffixã¨ã„ã†ä¸‰ã¤ã®å€¤ã‚’è¿”ã—ã€[ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆ](https://doc.rust-lang.org/reference/type-layout.html#r-layout.properties.align)ã‚’ç¶­æŒã§ããªã‹ã£ãŸå‰æ®µãŒprefixã€å¾Œæ®µã®å€¤ãŒsuffixã«å…¥ã‚Šã¾ã™ã€‚

åŸºæœ¬å¾Œæ®µã«å€¤ãŒå…¥ã‚‹ã“ã¨ã¯ãªã„ã§ã™ãŒã€prefixã®ã¿å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã¾ã™ã€‚

```rs
let (head, slice, _) = unsafe { byte_slice.align_to::<T>() };
if !head.is_empty() {
    return Err(agent.throw_exception_with_static_message(
        ExceptionType::TypeError,
        "TypedArray is not properly aligned",
        gc,
    ));
}
```

ã“ã“ã¾ã§ã§ã€å¯¾è±¡ã®TypedArrayã®sliceã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚
æœ€å¾Œã«ã€`TypedArray.prototype.indexOf`ã®å¼•æ•°ã«æ¸¡ã•ã‚ŒãŸå€¤ã¨ã€sliceã®ãƒ‡ãƒ¼ã‚¿ãŒä¸€è‡´ã™ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚

```rs
let len = len.min(slice.len());
if ASCENDING {
    if k >= len {
        return Ok(None);
    }
    Ok(slice[k..len]
        .iter()
        .position(|&r| r == search_element)
        .map(|pos| pos + k))
} else {
    if k >= len {
        return Ok(None);
    }
    Ok(slice[..=k].iter().rposition(|&r| r == search_element))
}
```

ASCENDINGã¯ã€indexOfã¨lastIndexOfã®é•ã„ã§ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã§æ¸¡ã•ã‚ŒãŸã‚‚ã®ã§ã™ã€‚

iterã¨positoinã‚’ä½¿ã†ã“ã¨ã§ã€indexOfç›¸å½“ã®ã‚‚ã®ã‚’ä½œã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã“ã®åˆ¤å®šã§è¿”ã•ã‚ŒãŸçµæœãŒã€æœ€çµ‚çš„ãªindexOfã®çµæœã«ãªã‚Šã¾ã™ã€‚

ä»¥ä¸ŠãŒã€ä»Šå›è¡Œã£ãŸæœ€é©åŒ–ã®è©±ã§ã™ã€‚

## ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœ

æœ€å¾Œã«çµæœã§ã™ã€‚å‚è€ƒã¨ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’ç”¨æ„ã—ã¾ã—ãŸã€‚

```js
const SIZE = 10_000_000;
const arr = new Uint32Array(SIZE);
arr.indexOf(9999999);
```

ã“ã‚Œã¯å€¤ãŒ0ã®è¦ç´ ãŒ1000ä¸‡å€‹ä½œã‚‰ã‚Œã€ãã‚Œã«å¯¾ã—ã¦indexOfã¯9999999ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã®ã§ã€ã‹ãªã‚Šã®æ•°ãƒ«ãƒ¼ãƒ—ã—ã¾ã™ã€‚

å®Ÿéš›ã«ã“ã‚Œã‚’linuxã®timeã‚³ãƒãƒ³ãƒ‰ã§æ¸¬ã£ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```
// æœ€é©åŒ–å‰
â¯ time cargo run eval index.js
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.08s
     Running `target/debug/nova_cli eval index.js`
cargo run eval index.js  16.88s user 0.29s system 96% cpu 17.724 total

// æœ€é©åŒ–å¾Œ
â¯ time cargo run eval index.js
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.08s
     Running `target/debug/nova_cli eval index.js`
cargo run eval index.js  0.16s user 0.07s system 35% cpu 0.655 total
```

- æœ€é©åŒ–å‰: ç´„17ç§’
- æœ€é©åŒ–å¾Œ: ç´„0.6ç§’

ç´„28å€é«˜é€ŸåŒ–ã§ãã¦ã„ã¾ã™ã€‚ãã‚Œã«CPUä½¿ç”¨ç‡ã‚‚ã‹ãªã‚Šä½ã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

## ã¾ã¨ã‚

ä»¥ä¸ŠãŒã€ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ãŸNovaã®TypedArray.prototype.indexOfã®æœ€é©åŒ–ã®è©±ã«ãªã‚Šã¾ã™ã€‚
ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã§æ¸¬ã£ãŸã‚³ãƒ¼ãƒ‰ã¯ã‹ãªã‚Šã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã«ã¯ãªã‚Šã¾ã™ãŒã€ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ã®æ–¹ãŒåœ§å€’çš„ã«é€Ÿã„ã“ã¨ãŒä½“é¨“ã§ãã¾ã—ãŸã€‚