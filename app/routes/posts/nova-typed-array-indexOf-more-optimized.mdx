---
title: "ネイティブコードを使ったNovaのTypedArray.prototype.indexOfの最適化"
description: "a"
date: "2025/03/09"
updatedAt: "2025/03/09"
path: "nova-typed-array-indexOf-more-optimized"
published: true
---

## Intro

先日、Novaに`%TypedArray%.prototype.indexOf`([#556](https://github.com/trynova/nova/pull/556))というPRがマージされました。

大枠の部分は他の実装と同じなんですが、今回行った最適化の方法が参考になったのでメモがてら残しておきます。

なお、まだベンチマークは取っていないので、多分こっちの方が早い程度です。

## %TypedArray%.prototype.indexOfの仕様

[%TypedArray%.prototype.indexOf](https://tc39.es/ecma262/multipage/indexed-collections.html#sec-%typedarray%.prototype.indexof)は、
引数に受け取った値のindex番号目の値を返すメソッドです。

基本的には以下のように使用します。

```ts
// ref: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray/indexOf#try_it

const uint8 = new Uint8Array([10, 20, 30, 40, 50]);

console.log(uint8.indexOf(50));
// Expected output: 4
```

そして、もし指定した値が存在しなかった場合は-1を返します。
あとは第二引数のfromIndexに値を入れることで、index番目移行から探索を始めることができます。
以下のような感じです。

```ts
// From position 3
console.log(uint8.indexOf(20, 3));
// Expected output: -1

console.log(uint8.indexOf(51));
// Expected output: -1
```

基本的には[Array.prototype.indexOf()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/indexOf)と同じですが、
TypedArrayは[TypedArray objects](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray#typedarray_objects)しか扱えません。

### 仕様書を見る
ここで、今回の最適化のポイントである、indexOfの探索方法を確認します。

これは、仕様書を見ると、以下のようになっています。

```
11. Repeat, while k < len,
    a. Let Pk be ! ToString(𝔽(k)).
    b. Let kPresent be ! HasProperty(O, Pk).
    c. If kPresent is true, then
       i. Let elementK be ! Get(O, Pk).
       ii. If IsStrictlyEqual(searchElement, elementK) is true, return 𝔽(k).
    d. Set k to k + 1.
```

lenはTypedArrayのlegnthで、kはここでは最初は0として考えてもらって問題ないです。

そして、lengthがkeyより大きい数字である限り、ループを続けるようになっています。

これが最終的に、indexOfに渡された引数（searchElement）と、TypedArrayに定義した値（elementK)を比較し、等価であれば、kを返すようになっています。

## 行った最適化

indexOfの最後の探索はようは単純なループ処理でした。

なので筆者もこれを実装した際には以下のように愚直にループ処理を行いました。

## 苦戦したポイント

### Rustそのものの理解

### 

## まとめ