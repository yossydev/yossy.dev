---
title: "Denoã®Web Workerã®å‡¦ç†ã‚’èª­ã‚€"
emoji: "ğŸ¦•"
description: "å°‘ã—å‰ã«ã€Agentsã‚’ç†è§£ã—ãŸã„ã¨ã„ã†ãƒ–ãƒ­ã‚°ã‚’æ›¸ã„ãŸã€‚ã“ã‚Œã¯Web Workerã®å®Ÿè£…ã®ãŸã‚ã ã£ãŸãŒã€ä»Šå›ã¯å…·ä½“çš„ã«Web Workerã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã§ã„ããŸã„"
date: "2025/12/02"
updatedAt: "2025/12/02"
path: "deno-web-worker"
published: true
---

## Intro

å°‘ã—å‰ã«ã€[Agentsã‚’ç†è§£ã—ãŸã„](https://yossy.dev/posts/js-agents) ã¨ã„ã†ãƒ–ãƒ­ã‚°ã‚’æ›¸ã„ãŸã€‚

ã“ã‚Œã¯Web Workerã®å®Ÿè£…ã®ãŸã‚ã ã£ãŸãŒã€ä»Šå›ã¯å…·ä½“çš„ã«Web Workerã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã§ã„ããŸã„

## Web Workerã‚’ç†è§£ã™ã‚‹

ã¾ãšã‚´ãƒ¼ãƒ«ã‚’ãã‚ãŸã„ã€‚ä»¥ä¸‹ã®ã‚ˆã†ãªç°¡å˜ãªworkerã‚³ãƒ¼ãƒ‰ãŒã©ã®ã‚ˆã†ã«Denoã¯å‹•ã‹ã•ã‚Œã¦ã„ã‚‹ã®ã‹ã‚’ã–ã£ãã‚Šç†è§£ã—ãŸã„ã€‚


```typescript
// main.ts
const worker = new Worker(
  new URL("./worker.ts", import.meta.url).href,
  { type: "module" },
);

worker.postMessage({
  filename: new URL("./log.txt", import.meta.url).pathname
});
```

```typescript
// worker.ts
self.onmessage = async (e) => {
  const { filename } = e.data;
  const text = await Deno.readTextFile(filename);
  self.close();
};
```

## new Worker

ã¾ãšã¯`new Worker`ã®å‡¦ç†ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã¦ã¿ã‚‹ã€‚constructorãŒã‚ã‚‹ã¯ãšã€‚

[https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/runtime/js/11_workers.js#L94-L140](https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/runtime/js/11_workers.js#L94-L140) ã§constructorã‚’å®šç¾©ã—ã¦ã„ã‚‹

ãã®ä¸­ã§createWorkerã¨ã„ã†é–¢æ•°ã‚’ã•ã‚‰ã«èª­ã‚“ã§ã„ã‚‹ã€‚ã“ã‚ŒãŒ

[https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/runtime/ops/worker_host.rs#L143-L265](https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/runtime/ops/worker_host.rs#L143-L265) ã«è©²å½“ã—ã¦ã„ã‚‹ã€‚

ãã®ä¸­ã‚’è¦‹ã¦ã„ã‚‹ã¨ã€run_web_workerãŒè¦‹ã¤ã‹ã‚‹ã€‚

[https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/runtime/ops/worker_host.rs#L228-L237](https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/runtime/ops/worker_host.rs#L228-L237)

ãŸã ã“ã“ã§ã¯ã™ã§ã«isolateï¼ˆå¤‰æ•°åã§ã¯workerï¼‰ãŒæ¸¡ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€workerç”¨ã®isolateã®å‘¼ã³å‡ºã—ã¯ãã®å‰ã®ä»¥ä¸‹ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹

[https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/runtime/ops/worker_host.rs#L212-L222](https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/runtime/ops/worker_host.rs#L212-L222)

ã“ã‚Œã¯ã¡ã‚‡ã£ã¨è‡ªåˆ†ã®Rustã®çŸ¥è­˜ä¸è¶³ã§è‹¦æˆ¦ã—ãŸã®ã ãŒã€ã“ã‚Œã¯ã©ã†ã‚„ã‚‰ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ãƒ¼ã¨ã„ã†æ–¹æ³•ã‚’æ´»ç”¨ã—ã¦ã„ã‚‹ã‚‰ã—ã„ã€‚

[https://doc.rust-jp.rs/book-ja/ch13-01-closures.html](https://doc.rust-jp.rs/book-ja/ch13-01-closures.html)

äº‹å‰ã«å®šç¾©ã•ã‚ŒãŸé–¢æ•°ã‚’ã“ã“ã§ã¯stateã«æ ¼ç´ã—ã¦ã€ãã‚Œã‚’å†åº¦å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã€‚

ã§ã¯ä¸€ç•ªæœ€åˆã«ã©ã“ã§isolateã‚’ä½œã£ã¦ã„ã‚‹ã‹ã¨ã„ã†ã¨ã€ä»¥ä¸‹ã«ãªã‚‹ã€‚

[https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/cli/worker.rs#L326-L344](https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/cli/worker.rs#L326-L344)

deno run index.tsã¨ã‹deno index.tsã¨ã‹ã—ãŸã¨ãã«javascriptã‚’å‹•ã‹ã™ãŸã‚ã®mainã‚¹ãƒ¬ãƒƒãƒ‰ã®å‘¼ã³å‡ºã—ã§ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯å®Ÿè¡Œã•ã‚Œã‚‹ã€‚

ãã—ã¦ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ãƒ¼ã®ç™»éŒ²ã¯ä»¥ä¸‹ã§è¡Œã‚ã‚Œã‚‹ã€‚

[https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/cli/lib/worker.rs#L599-L731](https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/cli/lib/worker.rs#L599-L731)

[https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/cli/lib/worker.rs#L707](https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/cli/lib/worker.rs#L707)

ã‚ã‹ã‚Šã¥ã‚‰ã„ã®ã§æ•´ç†ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹

```text
1. deno run main.ts // cliã§å®Ÿè¡Œ
2. MainWorkerï¼ˆmain.tsï¼‰// main.tsã‚’å‹•ã‹ã™ãŸã‚ã®agentï¼ˆisolateï¼‰ãŒä½œã‚‰ã‚Œã‚‹
3. Web Workerï¼ˆnew Worker("./worker.ts")ï¼‰// workerã‚’å‹•ã‹ã™ãŸã‚ã®agentï¼ˆisolateï¼‰ãŒä½œã‚‰ã‚Œã‚‹
```

ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ãƒ¼ã®æ¦‚å¿µãŒå…¨ç„¶ã‚ã‹ã£ã¦ãªã‹ã£ãŸã®ã§ã€ã“ã“ã¯çµæ§‹è‹¦æˆ¦ã—ãŸã€‚

ã“ã“ã¾ã§ã§ã‚„ã£ã¨new Workerã®ã–ã£ãã‚Šå‡¦ç†ãŒç†è§£ã§ããŸã€‚

### worker.postMessage

æ¬¡ã«æŒ‡å®šã—ãŸã‚¹ãƒ¬ãƒƒãƒ‰ã¸ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹ä»•çµ„ã¿ã‚’ç†è§£ã™ã‚‹ã€‚

jsã¨rustã®postMessageé–¢é€£ã®å‡¦ç†ã¯ä»¥ä¸‹ã«ãªã‚‹

[https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/runtime/js/11_workers.js#L258-L288](https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/runtime/js/11_workers.js#L258-L288)

[https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/runtime/ops/worker_host.rs#L399-L414](https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/runtime/ops/worker_host.rs#L399-L414)

jsã¯rustã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼æ¸¡ã™ãŸã‚ã®æ•´å½¢ã‚’è¡Œã£ã¦ã„ã‚‹æ„Ÿã˜ã€‚å®Ÿæ…‹ã¯rustå´ã«ã‚ã‚‹ã‚ˆã†ã€‚

op_host_post_messageã®ä¸­ã«ã‚ã‚‹sendãƒ¡ã‚½ãƒƒãƒ‰ã¯ä»¥ä¸‹ã€‚

[https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/ext/web/message_port.rs#L60-L75](https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/ext/web/message_port.rs#L60-L75)

ã©ã†ã‚„ã‚‰tokioã‚’ä½¿ã£ã¦ä½œã‚‰ã‚Œã¦ã‚‹ã€‚

é€ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã¯ã©ã†ã‚„ã£ã¦æ±ºã‚ã¦ã„ã‚‹ã®ã ã‚ã†ã‹ï¼Ÿä¾‹ãˆã°workerãŒAã¨Bã®äºŒã¤ã‚ã£ãŸã¨ãã«ã€mainã‹ã‚‰Aã«é€ã‚‹æŒ‡å®šã®æ–¹æ³•ãŒçŸ¥ã‚ŠãŸã„

ã“ã“ã§è¦‹é€ƒã—ã¦ã„ãŸãŒã€WorkersTableã¨ã„ã†ã‚‚ã®ãŒã‚ã‚‹ã€‚

[https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/runtime/ops/worker_host.rs#L406-L407](https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/runtime/ops/worker_host.rs#L406-L407)

idã§getã—ã¦ã„ã‚‹ã ã‘ã§ã€ã•ã£ãã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæ™‚ã«worker_idã¨ã„ã†ã‚‚ã®ã‚’ä½œã£ã¦ã„ãŸã€‚

ãªã®ã§classå†…ã«private fieldã¨ã—ã¦å®šç¾©ã•ã‚Œã¦ã„ãŸã“ã®å€¤ã‚’rustå´ã«æ¸¡ã—ã¦ã€ãƒ¡ãƒ¢ãƒªã‹ã‚‰å¼•ã£å¼µã£ã¦ãã¦ã„ã‚‹æ„Ÿã˜ã¨ã„ã†ã“ã¨ãŒã‚ã‹ã£ãŸã€‚ã¨ã¦ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ã§ç›´æ„Ÿçš„ãªå‡¦ç†ã§ã‚ã‚‹ã€‚

[https://github.com/denoland/deno/blob/d5c0c89b49451f7fa4bc0b5940cdbe1e10003be4/runtime/js/11_workers.js#L285](https://github.com/denoland/deno/blob/d5c0c89b49451f7fa4bc0b5940cdbe1e10003be4/runtime/js/11_workers.js#L285)

### self.onmessage || worker.onmessage

ã•ã¦æœ€å¾Œã«æ¸¡ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®å—ã‘å–ã‚Šæ–¹ã‚’è¦‹ã¦ã„ããŸã„ã€‚

ã“ã‚Œã¯MainWorkerã¨self.onmessageã§å‘¼ã³å‡ºã—ãŸæ™‚ã«å‘¼ã°ã‚Œã‚‹ç®‡æ‰€ãŒç•°ãªã‚‹ã€‚

self.onmessageã¯ä»¥ä¸‹ã«ãªã‚‹

[https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/runtime/js/99_main.js#L206-L259](https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/runtime/js/99_main.js#L206-L259)

[https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/runtime/web_worker.rs#L993-L1003](https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/runtime/web_worker.rs#L993-L1003)

ãã—ã¦worker.onmessageã¯ä»¥ä¸‹ã«ãªã‚‹

[https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/runtime/js/11_workers.js#L186-L220](https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/runtime/js/11_workers.js#L186-L220)

[https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/runtime/js/11_workers.js#L221-L256](https://github.com/denoland/deno/blob/355d8994b2ab3b4979214d6d47ed70e39a37a92c/runtime/js/11_workers.js#L221-L256)

workerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæ™‚ã«ã“ã‚Œã‚‰ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã³å‡ºã•ã‚Œã€pollingã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚

å…·ä½“çš„ãªonmessageã®å‡¦ç†æ¢ã™ã®çµæ§‹è‹¦æˆ¦ã—ãŸã€‚

## çµ‚ã‚ã‚Šã«

Denoã®ã‚³ãƒ¼ãƒ‰ãŒã‚ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã«ä½œã‚‰ã‚Œã¦ã„ã¦åŠ©ã‹ã£ãŸã€‚

ã“ã‚Œã‚‰ã‚’å‚è€ƒã«Andromedaã§new Workerã‚’çµ„ã¿è¾¼ã‚“ã§ã„ãã€‚

